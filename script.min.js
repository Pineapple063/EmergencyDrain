document.addEventListener("DOMContentLoaded",()=>{let e=document.getElementById("uploadTrigger"),t=document.getElementById("fileInput"),i=document.getElementById("uploadStatus"),r=document.getElementById("imagePreviews"),n=document.getElementById("requestForm"),l=document.querySelector(".submit-btn"),a=[];function o(e){e.preventDefault(),e.stopPropagation()}async function s(e){let t=Array.from(e).filter(e=>e.type.startsWith("image/")),i=a.length,r=8-i,n=t.filter(e=>e.size<=10485760),o=t.filter(e=>e.size>10485760);if(n.length>r&&(n=n.slice(0,r),Swal.fire({icon:"warning",text:`Only the first ${r} valid images were processed to fit the 8 image limit.`})),0===n.length){a.length>=8&&Swal.fire({icon:"error",title:"Limit Reached",text:"You already have 8 images."}),o.length>0&&Swal.fire({icon:"error",title:"File too large",text:"One or more of the images you tried to upload is too large."});return}let s=n.length;d(s),void 0!==l&&(l.disabled=!0);let g=[],f={maxSizeMB:1,maxWidthOrHeight:1920,useWebWorker:!0,fileType:"image/webp",initalQuality:1,maxIteration:1};for(let u of n)try{let p=await imageCompression(u,f),h=u.name.replace(/\.[^/.]+$/,"")+".webp",v=new File([p],h,{type:"image/webp",lastModified:u.lastModified});g.push(v)}catch(b){console.error("Image compression error:",b)}o.length>0&&Swal.fire({icon:"warning",title:"Files too large",html:`The following files are over 10MB and were skipped:<br/><b>${o.map(e=>e.name).join("<br/>")}</b>`});let y=s-g.length;if(y>0)for(let w=0;w<y;w++){let L=a.length+s-1-w,E=document.getElementById(`image-preview-${L}`);E&&E.remove()}a=a.concat(g),c(g,null),m(),void 0!==l&&(l.disabled=!1)}function d(e){let t=a.length;for(let i=t;i<t+e;i++){let n=document.createElement("div");n.classList.add("preview-item"),n.classList.add("skeleton"),n.id=`image-preview-${i}`,n.innerHTML='<div class="loader"></div>',r.appendChild(n)}}function c(e=[],t=null){if(0===e.length&&null===t){r.innerHTML="";return}if(null!==t){let i=document.getElementById(`image-preview-${t}`);i&&i.remove();let n=r.querySelectorAll(".preview-item");for(let l=t;l<n.length;l++){let o=n[l];o.id=`image-preview-${l}`;let s=o.querySelector(".remove-btn");s&&(s.onclick=function(e){e.stopPropagation(),g(l)})}return}if(0===e.length)return;let d=a.length-e.length;e.forEach((e,t)=>{let i=d+t,r=document.getElementById(`image-preview-${i}`);if(r){r.innerHTML="";let n=document.createElement("img");n.src=URL.createObjectURL(e),n.alt=e.name;let l=document.createElement("button");l.classList.add("remove-btn"),l.innerHTML="&#10005;",l.title="Remove Image",l.onclick=function(e){e.stopPropagation(),g(i)},r.appendChild(n),r.appendChild(l),r.classList.remove("skeleton")}})}function g(e){a.splice(e,1),c([],e),m()}function m(){0===a.length?(i.textContent="No image selected",i.style.color="#888"):(i.textContent=`${a.length} / 8 photos selected`,i.style.color="#363b4e",i.style.fontWeight="bold")}function f(e){if(!e)return!1;let t=e.replace(/\D/g,"");return!!(t.length>=7)&&!!(t.length<=15)}e.addEventListener("click",()=>{t.click()}),t.addEventListener("change",()=>{s(t.files),t.value=""}),["dragenter","dragover","dragleave","drop"].forEach(t=>{e.addEventListener(t,o,!1)}),["dragenter","dragover"].forEach(t=>{e.addEventListener(t,()=>{e.classList.add("drag-over")},!1)}),["dragleave","drop"].forEach(t=>{e.addEventListener(t,()=>{e.classList.remove("drag-over")},!1)}),e.addEventListener("drop",e=>{let t=e.dataTransfer,i=t.files;s(i)}),n.addEventListener("submit",async e=>{e.preventDefault();let t=new FormData(n);if(!f(t.get("phone_number"))){Swal.fire({icon:"warning",text:"Please enter a valid phone number."});return}let i=t.get("area"),r=i.trim().replace(/\s+/g," ").replace(/\d/g,"");if(r.length<2){Swal.fire({icon:"warning",text:"Please enter a valid area/location."});return}l=document.querySelector(".submit-btn"),l.querySelector("p").innerHTML="Sending<br><span>Please wait</span>",l.disabled=!0;let o=document.querySelector("#submit-spinner");o&&o.classList.add("show"),t.delete("fileInput"),a.forEach(e=>{t.append("image",e)});try{let s=await fetch("https://contact-backend.fly.dev/submit",{method:"POST",body:t});if(s.ok)await s.json(),Swal.fire({icon:"success",title:"Submission Successful",text:"We will get back to you soon."}),n.reset(),a=[],c(newFiles=[],indexToRemove=null),m(),o&&o.classList.remove("show");else{let d=await s.json();429==s.status?Swal.fire({icon:"error",title:"Submission Failed",text:"Too many requests. Please try again later."}):Swal.fire({icon:"error",title:"Submission Failed",text:d.detail||d.error||"Submission failed"})}}catch(g){Swal.fire({icon:"error",text:"Submission failed"})}finally{l.querySelector("p").innerHTML="Send Request",l.disabled=!1,o&&o.classList.remove("show")}})});